========================================
  Amazon Q API 公网部署指南
========================================

【当前配置】
✅ API 密钥：sk-790214
✅ 配置文件：.env
✅ 监听端口：8000
✅ 鉴权模式：已启用


========================================
  方案一：内网穿透（最简单）⭐推荐
========================================

适合场景：
- 个人电脑部署
- 无公网 IP
- 快速测试公网访问

【1-1】使用 Cloudflare Tunnel（免费，稳定）

第一步：下载 cloudflared
https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/

Windows 直接下载：
https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe

重命名为 cloudflared.exe 并放到系统 PATH 或当前目录


第二步：启动本地服务
双击：启动公网服务.bat


第三步：启动内网穿透
打开新终端，双击：内网穿透_Cloudflare.bat

会显示类似：
  https://xxxx-xxxx-xxxx.trycloudflare.com

这就是你的公网地址！


第四步：测试访问
浏览器访问：https://xxxx-xxxx-xxxx.trycloudflare.com

客户端配置：
  API 地址：https://xxxx-xxxx-xxxx.trycloudflare.com/v1
  API 密钥：sk-790214


【1-2】使用 Ngrok（免费额度有限）

第一步：注册并下载
https://ngrok.com/download
注册账号获取 authtoken

第二步：配置 authtoken
ngrok authtoken YOUR_TOKEN

第三步：启动本地服务
双击：启动公网服务.bat

第四步：启动内网穿透
双击：内网穿透_ngrok.bat

会显示：
  Forwarding: https://xxxx.ngrok.io -> http://localhost:8000

第五步：使用
  API 地址：https://xxxx.ngrok.io/v1
  API 密钥：sk-790214


========================================
  方案二：路由器端口转发
========================================

适合场景：
- 有固定公网 IP
- 家庭宽带
- 长期稳定运行

第一步：启动服务
双击：启动公网服务.bat
（会监听 0.0.0.0:8000）

第二步：配置路由器
登录路由器管理界面（通常是 192.168.1.1）

找到"端口转发"或"虚拟服务器"设置：
  外部端口：8000
  内部 IP：你的电脑局域网IP（如 192.168.1.100）
  内部端口：8000
  协议：TCP

第三步：查看公网 IP
访问：https://ip.sb/
或：https://www.ip138.com/

第四步：访问测试
浏览器：http://你的公网IP:8000

客户端：
  API 地址：http://你的公网IP:8000/v1
  API 密钥：sk-790214

⚠️ 注意：
1. 确保防火墙允许 8000 端口
2. 部分运营商可能封禁家庭宽带端口
3. 建议使用 HTTPS（需要配置 SSL 证书）


========================================
  方案三：云服务器部署（推荐生产）
========================================

适合场景：
- 企业使用
- 高可用要求
- 需要域名和 HTTPS

【支持的云平台】
- 阿里云
- 腾讯云
- 华为云
- AWS
- Azure
- Google Cloud

【部署步骤】

第一步：购买服务器
配置建议：
- CPU：1核
- 内存：1GB
- 带宽：1Mbps
- 系统：Ubuntu 20.04 或 Windows Server

第二步：上传项目文件
使用 FTP/SFTP 上传整个 amazonq2api 目录

第三步：安装 Python 环境
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip

# Windows
从 python.org 下载安装

第四步：安装依赖
cd amazonq2api
pip3 install -r requirements.txt

第五步：启动服务
# 方式1：直接启动
python3 -m uvicorn app:app --host 0.0.0.0 --port 8000

# 方式2：后台运行（Linux）
nohup python3 -m uvicorn app:app --host 0.0.0.0 --port 8000 > api.log 2>&1 &

# 方式3：使用 systemd（推荐）
见下方 systemd 配置

第六步：配置防火墙
# 云平台安全组
开放端口：8000/TCP

# 服务器防火墙（Ubuntu）
sudo ufw allow 8000/tcp
sudo ufw reload

第七步：测试访问
http://服务器公网IP:8000

客户端配置：
  API 地址：http://服务器公网IP:8000/v1
  API 密钥：sk-790214


【配置 Systemd 服务（Linux）】

创建文件：/etc/systemd/system/amazonq-api.service

[Unit]
Description=Amazon Q to OpenAI API Bridge
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/path/to/amazonq2api
ExecStart=/usr/bin/python3 -m uvicorn app:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target

启动服务：
sudo systemctl daemon-reload
sudo systemctl enable amazonq-api
sudo systemctl start amazonq-api
sudo systemctl status amazonq-api


【配置 Nginx 反向代理 + HTTPS】

安装 Nginx：
sudo apt install nginx certbot python3-certbot-nginx

创建配置：/etc/nginx/sites-available/amazonq-api

server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

启用配置：
sudo ln -s /etc/nginx/sites-available/amazonq-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

申请 SSL 证书：
sudo certbot --nginx -d your-domain.com

访问：https://your-domain.com


========================================
  方案四：Docker 部署
========================================

第一步：创建 Dockerfile（已提供）

第二步：构建镜像
docker build -t amazonq-api .

第三步：运行容器
docker run -d \
  --name amazonq-api \
  -p 8000:8000 \
  --restart always \
  -v $(pwd)/accounts.db:/app/accounts.db \
  amazonq-api

第四步：查看日志
docker logs -f amazonq-api


========================================
  客户端使用配置
========================================

【API 配置】
API 地址：http://你的域名或IP:8000/v1
API 密钥：sk-790214
模型：claude-sonnet-4.5（或任意名称）

【Python 代码】
import openai

client = openai.OpenAI(
    base_url="http://你的域名或IP:8000/v1",
    api_key="sk-790214"
)

response = client.chat.completions.create(
    model="claude-sonnet-4.5",
    messages=[{"role": "user", "content": "你好"}]
)

print(response.choices[0].message.content)


【cURL 测试】
curl -X POST http://你的域名或IP:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-790214" \
  -d '{
    "model": "claude-sonnet-4.5",
    "messages": [{"role": "user", "content": "你好"}]
  }'


========================================
  安全建议
========================================

1. ✅ 使用强 API 密钥
   推荐格式：sk-随机字符串32位以上
   当前：sk-790214（建议更换为更强密钥）

2. ✅ 启用 HTTPS
   使用 Cloudflare / Let's Encrypt 免费证书

3. ✅ 配置防火墙
   只开放必要端口（80, 443, 8000）

4. ✅ 定期更新密钥
   建议每月更换一次

5. ✅ 监控访问日志
   查看是否有异常请求

6. ✅ 限制访问频率
   使用 Nginx rate_limit

7. ✅ 备份账号数据
   定期备份 accounts.db


========================================
  故障排查
========================================

【问题1】无法访问
- 检查服务是否启动
- 检查防火墙是否开放端口
- 检查云平台安全组配置

【问题2】403 Forbidden
- 检查 API 密钥是否正确
- 检查请求头：Authorization: Bearer sk-790214

【问题3】账号无响应
- 点击"刷新 Token"按钮
- 检查账号是否启用
- 查看服务器日志

【问题4】内网穿透断开
- Cloudflare Tunnel：会自动重连
- Ngrok：免费版会定期断开，需要手动重启


========================================
  推荐方案总结
========================================

【个人使用】
→ Cloudflare Tunnel
→ 完全免费
→ 无需公网 IP
→ 自动 HTTPS
→ 稳定可靠

【企业使用】
→ 云服务器 + Nginx + HTTPS
→ 独立域名
→ 高可用
→ 可扩展

【快速测试】
→ Ngrok
→ 5分钟部署
→ 免费额度


========================================
  快速开始（推荐新手）
========================================

1. 下载 cloudflared
   https://github.com/cloudflare/cloudflared/releases

2. 放到 amazonq2api 目录

3. 双击：启动公网服务.bat

4. 新开终端，运行：
   cloudflared tunnel --url http://localhost:8000

5. 复制显示的 https://xxx.trycloudflare.com

6. 在客户端配置：
   API 地址：https://xxx.trycloudflare.com/v1
   API 密钥：sk-790214

7. 开始使用！


========================================
  获取帮助
========================================

项目地址：https://codeberg.org/Korieu/amazonq2api
Issue：遇到问题可以提 Issue
文档：查看 README.md

